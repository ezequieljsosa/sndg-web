{% extends "base.html" %}

{% load crispy_forms_tags %}


{% load static %}
{% load bioresources_extras %}

{% block head %}

{% endblock %}

{% block content %}
<div class="row">
<div class="col-lg-9">

    {% csrf_token %}
    <button id="browseButton">Select</button>


    <div id="div_files"></div>


        <p><input type="button" value="send" id="btn_start_upload" /></p>






    <script type="text/javascript" src="{% static 'resumable.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var csrftoken = $("[name=csrfmiddlewaretoken]").val();
            var r = new Resumable({
                simultaneousUploads :1 ,maxFiles:1,
                target:'{% url 'bioresources:upload' %}',
                query:{csrfmiddlewaretoken:csrftoken}
            });

            r.on('fileSuccess',(file) => {
                $("#progressbar").removeClass("bg-info").addClass("bg-success");
                $("#progressbar").css('width',"100%");
                $('#btn_start_upload').show();
                $('#browseButton').show();
                $('#btnCancel').remove();
            });
            r.on('fileProgress',(file) => {
                $("#progressbar").css('width', Math.round( file.progress() * 100 ).toString() + "%" );

            });
            r.on('fileAdded',(file) => {
                $("#div_files").empty();
                $("#div_files").append($("<span/>").html(file.fileName));
                const progressBar = $("<div/>",{id:"progressbar",
                    "aria-valuemin":0,"aria-valuenow":0,
                    "aria-valuemax":100,role:"progressbar"
                }).addClass("progress-bar").addClass("bg-info");
                const progressContainer =  $("<div/>",{height: "20px"}).addClass("progress");
                progressContainer.append(progressBar)
                $("#div_files").append(progressContainer  );
                console.log(file)
            });
            r.on('fileRetry',(file) => {
                console.log("retrying...")
            });
            r.on('fileError',(file, message) => {
                $("#progressbar").removeClass("bg-info").addClass("bg-danger");
                $('#btn_start_upload').show();
                $('#browseButton').show();
                $('#btnCancel').remove();
                alert(message)
            });
            /*
            r.on('catchAll' ,x=>{
                console.log(x)
            })
            */
            if(!r.support) {alert("browser not supported")};
            r.assignBrowse(document.getElementById('browseButton'));
            $("#btn_start_upload").click(()=> {
                $('#btn_start_upload').hide();
                $('#browseButton').hide();
                $("#div_files").append($("<button/>",{id:"btnCancel"}).html("Cancel").click(()=>{file.cancel(); }));
                r.upload();
            });
        }, false);


    </script>


</div>
</div>
{% endblock %}